(function(h,j,n){var b=(function(){var t=function(y){if(!y||y=="none"){return[1,0,0,1,0,0]}return y.match(/(-?[0-9\.]+)/g)};var v=function(y){return y.css("-webkit-transform")||y.css("transform")||y.css("-moz-transform")||y.css("-o-transform")||y.css("-ms-transform")};var r=function(y){var z=v(y);return t(z)};var u=function(z,y){z.css("-webkit-transform",y);z.css("-moz-transform",y);z.css("-o-transform",y);z.css("-ms-transform",y);z.css("transform",y)};var x=function(y){return"matrix("+y[0]+", "+y[1]+", "+y[2]+", "+y[3]+", "+y[4]+", "+y[5]+")"};var w=function(z){var y=r(z);return{x:parseInt(y[4]),y:parseInt(y[5])}};var q=function(B,A){var y=r(B);y[0]=y[3]=A;var z=x(y);u(B,z)};var d=function(C,z,D){var A=r(C);A[4]=z;A[5]=D;var B=x(A);u(C,B)};var s=function(D,C){var z=r(D);var B=C*(Math.PI/180);var y=B*-1;z[1]=B;z[2]=y;var A=x(z);u(D,A)};return{scale:q,translate:d,rotate:s,getTranslate:w}})();var i=n.navigator.platform=="MacIntel",e=0,c=0,a={command:false,shift:false,isSelecting:false},m={66:"bold",73:"italic",85:"underline",112:"h1",113:"h2",122:"undo"},p,l={keyboard:{isCommand:function(r,q,d){if(i&&r.metaKey||!i&&r.ctrlKey){q()}else{d()}},isShift:function(r,q,d){if(r.shiftKey){q()}else{d()}},isModifier:function(r,s){var d=r.which,q=m[d];if(q){s.call(this,q)}},isEnter:function(d,q){if(d.which===13){q()}},isArrow:function(d,q){if(d.which>=37||d.which<=40){q()}}},html:{addTag:function(s,d,q,r){var t=h(j.createElement(d));t.attr("contenteditable",Boolean(r));t.append(" ");s.append(t);if(q){a.focusedElement=s.children().last();l.cursor.set(s,0,a.focusedElement)}return t}},cursor:{set:function(u,w,r){var t;if(j.createRange){t=j.createRange();var x=n.getSelection(),d=u.children().last(),q=d.html().length-1,s=r?r[0]:d[0],v=typeof w!=="undefined"?w:q;t.setStart(s,v);t.collapse(true);x.removeAllRanges();x.addRange(t)}else{t=j.body.createTextRange();t.moveToElementText(r);t.collapse(false);t.select()}}},selection:{save:function(){if(n.getSelection){var d=n.getSelection();if(d.rangeCount>0){return d.getRangeAt(0)}}else{if(j.selection&&j.selection.createRange){return j.selection.createRange()}}return null},restore:function(d){if(d){if(n.getSelection){var q=n.getSelection();q.removeAllRanges();q.addRange(d)}else{if(j.selection&&d.select){d.select()}}}},getText:function(){var d="";if(n.getSelection){d=n.getSelection().toString()}else{if(j.getSelection){d=j.getSelection().toString()}else{if(j.selection){d=j.selection.createRange().text}}}return d},clear:function(){if(window.getSelection){if(window.getSelection().empty){window.getSelection().empty()}else{if(window.getSelection().removeAllRanges){window.getSelection().removeAllRanges()}}}else{if(document.selection){document.selection.empty()}}},getContainer:function(d){if(n.getSelection&&d&&d.commonAncestorContainer){return d.commonAncestorContainer}else{if(j.selection&&d&&d.parentElement){return d.parentElement()}}return null},getSelection:function(){if(n.getSelection){return n.getSelection()}else{if(j.selection&&j.selection.createRange){return j.selection}}return null}},validation:{isUrl:function(d){return(/^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)*\/?$/).test(d)}}},k={updatePos:function(v,s){var r=n.getSelection(),u=r.getRangeAt(0),q=u.getBoundingClientRect(),x=s.width(),d=s.height(),t=v.offset().left,w={x:(q.left+q.width/2)-(x/2),y:q.top-d-8+h(document).scrollTop()};b.translate(s,w.x,w.y)},updateState:function(s,t){t.find("button").removeClass("active");var u=n.getSelection(),d=[];k.checkForFormatting(u.focusNode,d);var q={"b":"bold","i":"italic","u":"underline","h1":"h1","h2":"h2","a":"anchor","ul":"ul","ol":"ol"};for(var r=0;r<d.length;r++){var v=d[r];t.find("button."+q[v]).addClass("active")}},checkForFormatting:function(q,d){var r=["b","i","u","h1","h2","ol","ul","li","a"];if(q.nodeName==="#text"||r.indexOf(q.nodeName.toLowerCase())!=-1){if(q.nodeName!="#text"){d.push(q.nodeName.toLowerCase())}k.checkForFormatting(q.parentNode,d)}},buildMenu:function(t,r){var u=l.html.addTag(r,"ul",false,false);for(var q in p.modifiers){var w=l.html.addTag(u,"li",false,false);var d=l.html.addTag(w,"button",false,false);d.attr("editor-command",p.modifiers[q]);d.addClass(p.modifiers[q])}r.find("button").click(function(z){z.preventDefault();var y=h(this).attr("editor-command");o.commands[y].call(t,z)});var s=l.html.addTag(r,"div",false,false);s.addClass("link-area");var x=l.html.addTag(s,"input",false,false);x.attr({type:"text"});var v=l.html.addTag(s,"button",false,false);v.click(function(z){z.preventDefault();var y=h(this).closest(".editor");h(this).closest(".link-area").hide();h(this).closest(".bubble").find("ul").show()})},show:function(){var d=h(this).parent().find(".bubble");if(!d.length){d=l.html.addTag(h(this).parent(),"div",false,false);d.addClass("jquery-notebook bubble")}d.empty();k.buildMenu(this,d);d.show();k.updateState(this,d);if(!d.hasClass("active")){d.addClass("jump")}else{d.removeClass("jump")}k.updatePos(h(this),d);d.addClass("active")},update:function(){var d=h(this).parent().find(".bubble");k.updateState(this,d)},clear:function(){var d=h(this).parent().find(".bubble");if(!d.hasClass("active")){return}d.removeClass("active");k.hideLinkInput.call(this);k.showButtons.call(this);setTimeout(function(){if(d.hasClass("active")){return}d.hide()},500)},hideButtons:function(){h(this).parent().find(".bubble").find("ul").hide()},showButtons:function(){h(this).parent().find(".bubble").find("ul").show()},showLinkInput:function(t){k.hideButtons.call(this);var s=this;var u=h(this).parent().find(".bubble").find("input[type=text]");var d=u.closest(".jquery-notebook").find("button.anchor").hasClass("active");u.unbind("keydown");u.keydown(function(w){var v=h(this);l.keyboard.isEnter(w,function(){w.preventDefault();var x=v.val();if(l.validation.isUrl(x)){w.url=x;o.commands.createLink(w,t);k.clear.call(s)}else{if(x===""&&d){o.commands.removeLink(w,t);k.clear.call(s)}}})});u.bind("paste",function(w){var v=h(this);setTimeout(function(){var x=v.val();if(/http:\/\/https?:\/\//.test(x)){x=x.substring(7);v.val(x)}},1)});var r="http://";if(d){var q=h(l.selection.getContainer(t)).closest("a");r=q.prop("href")||r}h(this).parent().find(".link-area").show();u.val(r).focus()},hideLinkInput:function(){h(this).parent().find(".bubble").find(".link-area").hide()}},f={bindEvents:function(d){d.keydown(g.keydown);d.keyup(g.keyup);d.focus(g.focus);d.bind("paste",o.paste);d.mousedown(g.mouseClick);d.mouseup(g.mouseUp);d.mousemove(g.mouseMove);d.blur(g.blur);h("body").mouseup(function(q){if(q.target==q.currentTarget&&a.isSelecting){g.mouseUp.call(d,q)}})},setPlaceholder:function(d){if(/^\s*$/.test(h(this).text())){h(this).empty();var q=l.html.addTag(h(this),"p").addClass("placeholder");q.append(h(this).attr("editor-placeholder"));l.html.addTag(h(this),"p",typeof d.focus!="undefined"?d.focus:false,true)}else{h(this).find(".placeholder").remove()}},removePlaceholder:function(d){h(this).find(".placeholder").remove()},preserveElementFocus:function(){var d=n.getSelection()?n.getSelection().anchorNode:j.activeElement;if(d){var u=d.parentNode,t=u!==a.focusedElement,r=this.children,s=0;if(u===this){u=d}for(var q=0;q<r.length;q++){if(u===r[q]){s=q;break}}if(t){a.focusedElement=u;a.focusedElementIndex=s}}},setContentArea:function(q){var r=h("body").find(".jquery-editor").length+1;q.attr("data-jquery-notebook-id",r);var d=h("body");contentArea=h("<textarea></textarea>");contentArea.css({position:"absolute",left:-1000});contentArea.attr("id","jquery-notebook-content-"+r);d.append(contentArea)},prepare:function(r,q){p=q;f.setContentArea(r);r.attr("editor-mode",p.mode);r.attr("editor-placeholder",p.placeholder);r.attr("contenteditable",true);r.css("position","relative");r.addClass("jquery-notebook editor");f.setPlaceholder.call(r,{});f.preserveElementFocus.call(r);if(p.autoFocus===true){var d=r.find("p:not(.placeholder)");l.cursor.set(r,0,d)}}},g={keydown:function(q){var d=this;if(a.command&&q.which===65){setTimeout(function(){k.show.call(d)},50)}l.keyboard.isCommand(q,function(){a.command=true},function(){a.command=false});l.keyboard.isShift(q,function(){a.shift=true},function(){a.shift=false});l.keyboard.isModifier.call(this,q,function(r){if(a.command){o.commands[r].call(this,q)}});if(a.shift){l.keyboard.isArrow.call(this,q,function(){setTimeout(function(){var r=l.selection.getText();if(r!==""){k.show.call(d)}else{k.clear.call(d)}},100)})}else{l.keyboard.isArrow.call(this,q,function(){k.clear.call(d)})}if(q.which===13){o.enterKey.call(this,q)}if(q.which===27){k.clear.call(this)}if(q.which===86&&a.command){o.paste.call(this,q)}if(q.which===90&&a.command){o.commands.undo.call(this,q)}},keyup:function(d){l.keyboard.isCommand(d,function(){a.command=false},function(){a.command=true});f.preserveElementFocus.call(this);f.removePlaceholder.call(this);if(/^\s*$/.test(h(this).text())){h(this).empty();l.html.addTag(h(this),"p",true,true)}o.change.call(this)},focus:function(d){a.command=false;a.shift=false},mouseClick:function(v){var t=this;a.isSelecting=true;if(h(this).parent().find(".bubble:visible").length){var q=h(this).parent().find(".bubble:visible"),s=q.offset().left,r=q.offset().top,u=q.width(),d=q.height();if(e>s&&e<s+u&&c>r&&c<r+d){return}}},mouseUp:function(q){var d=this;a.isSelecting=false;setTimeout(function(){var r=l.selection.save();if(r){if(r.collapsed){k.clear.call(d)}else{k.show.call(d);q.preventDefault()}}},50)},mouseMove:function(d){e=d.pageX;c=d.pageY},blur:function(d){f.setPlaceholder.call(this,{focus:false})}},o={commands:{bold:function(d){d.preventDefault();j.execCommand("bold",false);k.update.call(this);o.change.call(this)},italic:function(d){d.preventDefault();j.execCommand("italic",false);k.update.call(this);o.change.call(this)},underline:function(d){d.preventDefault();j.execCommand("underline",false);k.update.call(this);o.change.call(this)},anchor:function(q){q.preventDefault();var d=l.selection.save();k.showLinkInput.call(this,d);o.change.call(this)},createLink:function(q,d){l.selection.restore(d);j.execCommand("createLink",false,q.url);k.update.call(this);o.change.call(this)},removeLink:function(r,q){var d=h(l.selection.getContainer(q)).closest("a");d.contents().first().unwrap();o.change.call(this)},h1:function(d){d.preventDefault();if(h(window.getSelection().anchorNode.parentNode).is("h1")){j.execCommand("formatBlock",false,"<p>")}else{j.execCommand("formatBlock",false,"<h1>")}k.update.call(this);o.change.call(this)},h2:function(d){d.preventDefault();if(h(window.getSelection().anchorNode.parentNode).is("h2")){j.execCommand("formatBlock",false,"<p>")}else{j.execCommand("formatBlock",false,"<h2>")}k.update.call(this);o.change.call(this)},ul:function(d){d.preventDefault();j.execCommand("insertUnorderedList",false);k.update.call(this);o.change.call(this)},ol:function(d){d.preventDefault();j.execCommand("insertOrderedList",false);k.update.call(this);o.change.call(this)},undo:function(r){r.preventDefault();j.execCommand("undo",false);var q=n.getSelection(),d=q.getRangeAt(0),s=d.getBoundingClientRect();h(document).scrollTop(h(document).scrollTop()+s.top);o.change.call(this)}},enterKey:function(t){if(h(this).attr("editor-mode")==="inline"){t.preventDefault();t.stopPropagation();return}var s=l.selection.getSelection();var r=h(s.focusNode.parentElement);var d=r.next();if(!d.length&&r.prop("tagName")!="LI"){var q=r.prop("tagName");if(q==="OL"||q==="UL"){var u=r.children().last();if(u.length&&u.text()===""){u.remove()}}l.html.addTag(h(this),"p",true,true);t.preventDefault();t.stopPropagation()}o.change.call(this)},paste:function(t){var r=h(this),u="jqeditor-temparea",q=l.selection.save(),s=h("#"+u);if(s.length<1){var d=h("body");s=h("<textarea></textarea>");s.css({position:"absolute",left:-1000});s.attr("id",u);d.append(s)}s.focus();setTimeout(function(){var x="",w=s.val().split("\n");for(var v=0;v<w.length;v++){x+=["<p>",w[v],"</p>"].join("")}s.val("");l.selection.restore(q);j.execCommand("delete");j.execCommand("insertHTML",false,x);o.change.call(this)},500)},change:function(s){var d=h("#jquery-notebook-content-"+h(this).attr("data-jquery-notebook-id"));d.val(h(this).html());var r=d.val();var q=new CustomEvent("contentChange",{"detail":{"content":r}});this.dispatchEvent(q)}};h.fn.notebook=function(d){d=h.extend({},h.fn.notebook.defaults,d);f.prepare(this,d);f.bindEvents(this);return this};h.fn.notebook.defaults={autoFocus:false,placeholder:"Your text here...",mode:"multiline",modifiers:["bold","italic","underline","h1","h2","ol","ul","anchor"]}})(jQuery,document,window);